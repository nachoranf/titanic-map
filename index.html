<script>
  const coords = [
    [49.63700, -1.61700],   // Southampton
    [49.63705, -1.61705],   // Punto casi idéntico → no visible
    [48.0, -10.0],
    [47.0, -17.0],
    [46.0, -24.0],
    [45.0, -31.0],
    [44.0, -38.0],
    [43.0, -45.0],
    [42.5, -49.9469],       // Hundimiento
    [41.5, -56.0],
    [40.7128, -74.0060]     // Nueva York
  ];

  const hundimientoIndex = 8;
  const hundimiento = coords[hundimientoIndex];

  const map = L.map('map', {
    zoomControl: false,
    dragging: false,
    scrollWheelZoom: false,
    doubleClickZoom: false,
    boxZoom: false,
    keyboard: false,
    tap: false,
  }).setView([45, -40], 4);

  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const solidLine = L.polyline([], {
    color: 'red',
    weight: 4
  }).addTo(map);

  const dashedLine = L.polyline([], {
    color: 'red',
    weight: 3,
    dashArray: '6, 8'
  }).addTo(map);

  // Marcadores principales
  L.marker(coords[0]).addTo(map).bindTooltip("Southampton", { permanent: true, direction: 'right' });
  L.marker(coords[coords.length - 1]).addTo(map).bindTooltip("Nueva York", { permanent: true, direction: 'left' });

  let crossAdded = false;

  const scroller = scrollama();
  scroller
    .setup({
      step: ".step",
      offset: 0.5
    })
    .onStepEnter(response => {
      const step = parseInt(response.element.dataset.step);
      const index = Math.min(step - 1, coords.length - 1);

      // Solo empezar a trazar la línea sólida desde el paso 3 en adelante
      if (index >= 2) {
        const solidSegment = coords.slice(2, Math.min(index + 1, hundimientoIndex + 1));
        solidLine.setLatLngs([coords[1], ...solidSegment]); // agregamos el segundo punto como arranque
      } else {
        solidLine.setLatLngs([]); // limpiar si volvemos al inicio
      }

      // Línea punteada solo si paso el hundimiento
      if (index > hundimientoIndex) {
        const dashedSegment = coords.slice(hundimientoIndex, index + 1);
        dashedLine.setLatLngs(dashedSegment);
      } else {
        dashedLine.setLatLngs([]);
      }

      // Cruz ❌ en hundimiento (una vez)
      if (index >= hundimientoIndex && !crossAdded) {
        L.marker(hundimiento, {
          icon: L.divIcon({
            html: '❌',
            className: '',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
          })
        }).addTo(map).bindTooltip("Hundimiento", { permanent: true, direction: 'left' });
        crossAdded = true;
      }
    });
</script>

